require_relative '../node_modules/react-native/scripts/react_native_pods'
require_relative '../node_modules/@react-native-community/cli-platform-ios/native_modules'

platform :ios, min_ios_version_supported
prepare_react_native_project!

# 1. Permissions
permissions_path = '../node_modules/react-native-permissions/scripts/setup.rb'
if File.exist?(permissions_path)
  require_relative permissions_path
  setup_permissions([
    'Camera',
    'MediaLibrary',
    'Microphone',
    'PhotoLibrary',
    'PhotoLibraryAddOnly',
  ])
end

# 2. Static Framework (Bắt buộc cho Firebase & Nitro hoạt động chung)
use_frameworks! :linkage => :static

use_modular_headers!

target 'ieltshunter' do
  config = use_native_modules!

  # --- ĐÃ SỬA: Bỏ các flag thừa, chỉ giữ new_arch_enabled ---
  use_react_native!(
    :path => config[:reactNativePath],
    :app_path => "#{Pod::Config.instance.installation_root}/..",
    :new_arch_enabled => false # Tắt New Architecture (Fabric/TurboModules) tại đây
  )

  target 'ieltshunterTests' do
    inherit! :complete
  end

  post_install do |installer|
    # Sửa lỗi Folly Coroutine cũ (Giữ nguyên để an toàn)
    system("chmod -R u+w Pods/RCT-Folly")
    Dir.glob("Pods/RCT-Folly/folly/Portability.h").each do |file|
      text = File.read(file)
      if text.include? "#define FOLLY_HAS_COROUTINES 1"
        new_contents = text.gsub('#define FOLLY_HAS_COROUTINES 1', '#define FOLLY_HAS_COROUTINES 0')
        File.open(file, "w") { |file| file.puts new_contents }
      end
    end

    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false
    )

    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # --- FIX 1: Tắt Sandboxing (Cho Hermes) ---
        config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
        
        # --- FIX 2: CẤU HÌNH QUAN TRỌNG CHO NITRO MODULES ---
        # Ép toàn bộ project dùng C++20 (để khớp với Folly RN 0.76)
        config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++20'
        
        # --- FIX 3: SỬA LỖI 'folly/folly-config.h' NOT FOUND ---
        search_paths = config.build_settings['HEADER_SEARCH_PATHS'] || ['$(inherited)']
        
        # Thêm đường dẫn gốc nơi chứa folly-config.h
        search_paths << '"$(PODS_ROOT)/RCT-Folly"'
        
        # Thêm các đường dẫn Public Header khác cho chắc chắn
        search_paths << '"$(PODS_ROOT)/Headers/Public/RCT-Folly"'
        search_paths << '"$(PODS_ROOT)/Headers/Public/folly"'
        search_paths << '"$(PODS_ROOT)/Headers/Public/react-native-nitro-modules"'
        
        # Loại bỏ trùng lặp và lưu lại
        config.build_settings['HEADER_SEARCH_PATHS'] = search_paths.uniq.join(' ')
        
        # Đảm bảo thiết bị hỗ trợ
        config.build_settings['TARGETED_DEVICE_FAMILY'] = '1,2'
      end
    end
  end
end